<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Survey</title>
<style>
  :root { --accent:#000; --max:980px; --button-width: 520px; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:#fff; color:#333; height:100vh; display:flex; flex-direction:column; }
  header, footer { background:var(--accent); color:#fff; }
  header { padding:16px 0; }
  footer { padding:18px 0; }
  .brand { max-width:var(--max); margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; }
  .brand strong { font-size:18px; font-weight:600; letter-spacing:.3px; }
  main { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%; max-width:var(--max); margin:0 auto; padding:20px; }
  .stage { display:flex; flex-direction:column; align-items:center; width:100%; }
  .question { font-size:22px; line-height:1.4; color:#666; text-align:center; margin:22px 0 18px; }
  .btn {
    display:block; width:100%; max-width:var(--button-width);
    background:var(--accent); color:#fff; text-align:center;
    border-radius:10px; border:0; padding:16px 14px; margin:10px 0;
    font-size:18px; cursor:pointer; transition:opacity .2s;
  }
  .btn:hover { opacity:.88; }
  .content { max-width:780px; margin:0 auto; text-align:center; }
  .content img { max-width:420px; width:100%; height:auto; border-radius:10px; margin:12px auto 6px; display:block; }
  .notice { text-align:center; color:#777; font-size:14px; margin-top:14px; }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <strong>Test &amp; Keep a PS5</strong>
      <div></div>
    </div>
  </header>

  <main>
    <section id="screen" class="stage"></section>
    <p class="notice">Affiliate disclosure: some links may be affiliate; we may earn a commission at no extra cost to you.</p>
  </main>

  <footer>
    <div class="brand"><small>Â© PrizePaths</small><small></small></div>
  </footer>

<script>
const FORM_ENDPOINT = "https://script.google.com/macros/s/AKfycbyt63oXcKEV52qZntQZtIh-LSAgP8XmDAsqiU8M_UuJm6uFJlwZNE779-wweeAAmQzN7Q/exec";
const RESULTS_URL   = 'results.html';

let config=null, step=0, answers={}, locking=false;
const $ = (s, r=document)=>r.querySelector(s);

async function loadConfig(){
  const url = 'survey-config.json?v=' + Date.now(); // cache-bust
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('fetch failed ' + r.status);
  return r.json();
}
function render(){
  const s = config.screens[step];
  const host = $('#screen');
  host.innerHTML = '';

  // content & optional image
  if (s.html || s.image || (s.label && s.kind!=='radio' && s.kind!=='fields')) {
    const cont = document.createElement('div');
    cont.className = 'content';
    if (s.label && s.kind!=='radio' && s.kind!=='fields') {
      const h = document.createElement('div');
      h.className='question';
      h.textContent = s.label;
      cont.appendChild(h);
    }
    if (s.html)  cont.insertAdjacentHTML('beforeend', s.html);
    if (s.image) cont.insertAdjacentHTML('beforeend', `<img src="${s.image}" alt="">`);
    host.appendChild(cont);
  }

  // fields (name/email)
  if (s.kind === 'fields') {
    host.insertAdjacentHTML('beforeend', `<div class="question">${s.label||''}</div>`);
    host.insertAdjacentHTML('beforeend', `
      <div style="max-width:520px;margin:0 auto">
        <input id="name" placeholder="Full name" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px">
        <input id="email" type="email" placeholder="you@example.com" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px">
      </div>`);
    const next=document.createElement('button'); next.className='btn'; next.textContent='Next';
    next.onclick=()=>{
      const n=$('#name').value.trim(), e=$('#email').value.trim();
      if(!n||!e) return alert('Please enter name and email');
      answers.name=n; answers.email=e; step++; render();
    };
    host.appendChild(next);
    return;
  }

  // radio question
  if (s.kind === 'radio') {
    const q = document.createElement('div');
    q.className = 'question';
    q.textContent = s.label || '';
    host.appendChild(q);

    (s.options || []).forEach(opt=>{
      const o = typeof opt==='string' ? {label:opt, value:opt} : opt;
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = o.label;
      b.onclick = ()=>{
        if (locking) return; locking=true;
        answers[s.id] = o.value || o.label;

        if (o.href) {
          try {
            navigator.sendBeacon?.(FORM_ENDPOINT, new Blob([JSON.stringify({
              event:'affiliate_click',
              question_id:s.id,
              option_value:o.value||o.label,
              url:o.href,
              user_agent:navigator.userAgent
            })],{type:'application/json'}));
          } catch(_) {}
          window.open(o.href, '_blank', 'noopener');
        }

        step++;
        if (step < config.screens.length) render(); else finish();
        setTimeout(()=>locking=false, 120);
      };
      host.appendChild(b);
    });
    return;
  }

  // content-only screen => Next
  const next = document.createElement('button');
  next.className='btn'; next.textContent='Next';
  next.onclick = ()=>{ step++; (step < config.screens.length) ? render() : finish(); };
  host.appendChild(next);
}

async function finish(){
  try{
    const p = new URL(location.href).searchParams;
    const payload = {
      event: "response",
      name: answers.name || "",
      email: answers.email || "",
      answers: answers,
      user_agent: navigator.userAgent,
      utm_source: p.get("utm_source") || "github-pages",
      utm_medium: p.get("utm_medium") || "survey",
      utm_campaign: p.get("utm_campaign") || ""
    };
    const body = JSON.stringify(payload);
    let sent = false;
    if (navigator.sendBeacon){
      const blob = new Blob([body], {type: "text/plain"}); /* text/plain plays nice with beacon */
      sent = navigator.sendBeacon(FORM_ENDPOINT, blob);
    }
    if (!sent){
      /* Fallback: fetch with keepalive (survives unload in modern browsers) */
      await fetch(FORM_ENDPOINT,{
        method: "POST",
        headers: {"Content-Type":"text/plain"},
        body,
        keepalive: true
      });
    }
  }catch(e){ console.error(e);}
  setTimeout(()=>location.href = RESULTS_URL, 300); /* small delay to be extra safe */
}
}
}

(async function(){
  try { config = await loadConfig(); step = 0; render(); }
  catch (e) { $('#screen').innerHTML = '<p style="color:#c00;text-align:center;margin:24px 0;">Could not load survey-config.json</p>'; console.error(e); }
})();
</script>
</body>
</html>

